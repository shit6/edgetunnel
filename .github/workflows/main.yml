name: Universal Upstream Sync (Auto-Detect)

permissions:
  contents: write

on:
  schedule:
    - cron: "*/5 * * * *"  # 每5分钟检查一次
  workflow_dispatch:      # 允许手动触发

jobs:
  auto-sync:
    name: Auto Sync with Detected Upstream
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}  # 仅在 Fork 仓库运行

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Auto detect upstream repository
        id: detect_upstream
        run: |
          # 获取上游仓库地址
          UPSTREAM_URL=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}" | jq -r '.parent.full_name')
          
          if [ -z "$UPSTREAM_URL" ] || [ "$UPSTREAM_URL" = "null" ]; then
            echo "Error: 未识别到上游仓库！"
            exit 1
          fi
          
          echo "upstream_repo=$UPSTREAM_URL" >> $GITHUB_OUTPUT
          echo "✅ 自动识别到上游：$UPSTREAM_URL"

      - name: Force sync with upstream
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          upstream_sync_repo: ${{ steps.detect_upstream.outputs.upstream_repo }}
          upstream_sync_branch: main
          target_sync_branch: main
          target_repo_token: ${{ secrets.GITHUB_TOKEN }}
          force_sync: true
          test_mode: false

      - name: Sync failure check
        if: failure()
        run: |
          echo "❌ 同步失败！"
          echo "当前仓库：${{ github.repository }}"
          echo "上游仓库：${{ steps.detect_upstream.outputs.upstream_repo }}"
          exit 1
