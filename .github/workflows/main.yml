name: Force Sync with Upstream

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Force Sync
        run: |
          # 获取上游仓库地址
          UPSTREAM_URL=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}" | jq -r '.parent.clone_url')
          
          if [ -z "$UPSTREAM_URL" ] || [ "$UPSTREAM_URL" = "null" ]; then
            echo "Error: 未找到上游仓库"
            exit 1
          fi

          # 添加上游并强制同步
          git remote add upstream $UPSTREAM_URL
          git fetch upstream
          git checkout main
          git reset --hard upstream/main
          git push origin main --force
